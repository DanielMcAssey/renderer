#!/bin/bash

while true; do
	while [ -e deletions ]; do
		mv deletions deleting
		sftp -q -b deleting malcolm@netz.smurf.noris.de
		rm deleting
	done
	if [ -e sending ]; then
		backoff=0
		while ! sftp -q -b sending malcolm@netz.smurf.noris.de; do
			echo "SFTP failure - retrying"
			backoff=$(($backoff+1))
			sleep $((60*$backoff))
		done
		rm sending
	fi
	sleep 60
	while [ $(ls | grep -c '.send') -eq 0 ]; do
		sleep 60
	done
	for file in $(ls | grep '.send'); do
		mv $file send
		cat send >> sending
	done
	rm send
done
