#!/bin/bash

while true; do
	while [ -e tmp/deletions ]; do
		mv tmp/deletions tmp/deleting
#		sftp -q -b tmp/deleting malcolm@netz.smurf.noris.de
		rm tmp/deleting
	done
	if [ -e tmp/sending ]; then
		backoff=0
#		while ! sftp -q -b tmp/sending malcolm@netz.smurf.noris.de; do
#			echo "SFTP failure - retrying"
#			backoff=$(($backoff+1))
#			sleep $((60*$backoff))
#		done
		rm tmp/sending
	fi
	sleep 60
	while [ $(ls tmp | grep -c '.send') -eq 0 ]; do
		sleep 60
	done
	for file in $(ls tmp | grep '.send'); do
		mv tmp/$file tmp/send
		cat tmp/send >> tmp/sending
	done
	rm tmp/send
done
