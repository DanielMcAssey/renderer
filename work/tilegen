#!/bin/bash

tile () {
  tx=$(echo $1 | cut -f 1 -d'_')
  ty=$(echo $1 | cut -f 2 -d'_')
  bb=$(echo $1 | cut -f 3 -d'_')
	while [ $(ps -a | grep -c subtile) -gt 1 ]; do
		sleep 1
	done
	for k in {12..18}; do
		perl ../orp/orp.pl -r ../SeaMapStyles/osm-seamark-z$k.xml -b $bb -o tmp/panel_$k.svg tmp/$1 2>/dev/null &
	done;
	while [ $(ps -a | grep -c perl) -gt 1 ]; do
		sleep 1
	done
	mkdir -p tiles/12/$tx
  filename="tiles/12/$tx/$ty.png"
	inkscape panel_12.svg -e $filename -d 90 -a 256:256:512:512 -y 0 -b "#000000" 1>/dev/null 2>/dev/null
  if [ -e $filename ]; then
    if [ $(stat "$filename" | cut -f 8 -d' ') -lt 410 ]; then
      rm $filename
    else
      echo "put $filename cache/$(echo $filename | sed -e s?/?-?g)" >> tmp/12-$tx-$ty.send
    fi
  fi
	./subtile 12 $tx $ty 256 512 &
}

while true; do
  while [ $(ls tmp | grep -c "\_tile") -eq 0 ]; do
    sleep 10
  done
  for file in $(ls tmp | grep "\_tile"); do
    tile $file
    rm tmp/$file
  done
done
